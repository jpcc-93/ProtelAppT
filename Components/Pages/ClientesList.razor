@page "/clientes"
@using ProtelAppT.Data
@using Microsoft.EntityFrameworkCore
@inject ProtelAppT.Data.ProtelDbContext _dbContext
@inject NavigationManager _navigationManager
@inject IDialogService DialogService
@inject AuthenticationStateService _authServiceState
@using ProtelAppT.Service
@inject ClienteService _clienteService

@if (!_authServiceState.IsAuthenticated)
{
    _navigationManager.NavigateTo("/login");
}

<MudText Typo="Typo.h4" Class="mb-4" Align="Align.Center">Gestión de Clientes</MudText>

<MudTable Items="@clientes" @bind-clientesSeleccionados="clientesSeleccionados" Hover="true" ReadOnly="false" Dense="true" Breakpoint="Breakpoint.Sm">
    <ToolBarContent>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Variant="Variant.Outlined" OnClick="CrearCliente" />
    </ToolBarContent>
    <HeaderContent>
        <MudTh><MudTableSortLabel SortBy="new Func<Cliente, object>(x => x.IdCliente)">ID</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<Cliente, object>(x => x.Nombre)">Nombre</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<Cliente, object>(x => x.Email)">Email</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<Cliente, object>(x => x.Telefono)">Teléfono</MudTableSortLabel></MudTh>
        <MudTh>Estado</MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="ID">@context.IdCliente</MudTd>
        <MudTd DataLabel="Nombre">@context.Nombre</MudTd>
        <MudTd DataLabel="Email">@context.Email</MudTd>
        <MudTd DataLabel="Teléfono">@context.Telefono</MudTd>
        <MudTd DataLabel="Estado">@context.EstadoCliente?.Nombre</MudTd>
        <MudTd>
            <MudCheckBox T="bool"
                         Checked="@context.Seleccionado"
                         CheckedChanged="@GetCheckedChangedCallback(context)"
                         Color="Color.Primary" />
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager PageSizeOptions="new int[]{5, 10, 20}" />
    </PagerContent>
</MudTable>

<div class="d-flex justify-end mt-4">
@*     <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="ModificarClientesSeleccionados" Class="mr-2" Disabled="@(!clientesSeleccionados.Any())">Modificar</MudButton>
    <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="EliminarClientesSeleccionados" Disabled="@(!clientesSeleccionados.Any())">Eliminar</MudButton> *@
    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="ModificarClientesSeleccionados" Class="mr-2" >Modificar</MudButton>
    <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="EliminarClientesSeleccionados" >Eliminar</MudButton>
</div>

@code {
    private List<Cliente> clientes = new List<Cliente>();
    private HashSet<Cliente> clientesSeleccionados = new HashSet<Cliente>();

    protected override async Task OnInitializedAsync()
    {
        clientes = await _clienteService.GetAllClientesAsync();
        // Agregar una propiedad Seleccionado a cada cliente (esto no se guarda en la base de datos)
        clientes.ForEach(c => c.Seleccionado = false);
    }
    private EventCallback<bool> GetCheckedChangedCallback(Cliente cliente)
    {
        return EventCallback.Factory.Create<bool>(this, isChecked => OnClienteSeleccionadoChanged(cliente, isChecked));
    }

    private void OnClienteSeleccionadoChanged(Cliente cliente, bool isChecked)
    {
        cliente.Seleccionado = isChecked;

        if (isChecked)
            clientesSeleccionados.Add(cliente);
        else
            clientesSeleccionados.Remove(cliente);
    }

    private void CrearCliente()
    {
        _navigationManager.NavigateTo("/clientes/crear"); 
    }

    private void ModificarClientesSeleccionados()
    {
        if (clientesSeleccionados.Count == 1)
        {
            _navigationManager.NavigateTo($"/clientes/editar/{clientesSeleccionados.First().IdCliente}"); 
        }
        else if (clientesSeleccionados.Count > 1)
        {
            
            Console.WriteLine("No se puede modificar múltiples clientes a la vez.");
        }
        else
        {
            Console.WriteLine("Ningún cliente seleccionado.");
        }
    }

    private async Task EliminarClientesSeleccionados()
    {
        if (clientesSeleccionados.Any())
        {
            bool? result = await DialogService.ShowMessageBox(
                "Confirmar Eliminación",
                $"¿Seguro que quieres eliminar {clientesSeleccionados.Count} clientes?",
                yesText: "Eliminar",
                cancelText: "Cancelar");

            if (result == true)
            {
                await _clienteService.DeleteClientesAsync(clientesSeleccionados.ToList());
                clientes.RemoveAll(c => clientesSeleccionados.Contains(c));
                clientesSeleccionados.Clear();
                StateHasChanged();
            }
        }
    }
}